default:
  tags:
    - linux
  image: docker.ellisbs.co.uk:5190/ubuntu:24.04

stages:
  - test
  - scan
  - build
  - publish
  - build_docker
  - deploy

variables:
  SONAR_SCANNER_VERSION: 5.0.1.3006
  IMAGE_NAME: docker.ellisbs.co.uk:7070/bashman:latest
  DOCKER_USERNAME: docker

cache:
  paths:
    - .cache/pip/
    - venv/

run_tests:
  image: docker.ellisbs.co.uk:5190/python:3.12
  stage: test
  variables:
    BASHMAN_REQUIRE_AUTH: 0
    BASHMAN_AUTO_PUBLISH: 0
    # keep coverage DB somewhere always-writable
    COVERAGE_FILE: "/tmp/.coverage"
    # install into the one venv we create
    POETRY_VIRTUALENVS_CREATE: "false"
    # donâ€™t cache megabytes of wheels
    PIP_NO_CACHE_DIR: "1"
    # move Poetryâ€™s cache to a short-lived path (or disable; see step 2)
    POETRY_CACHE_DIR: "/tmp/poetry-cache"
  before_script:
    - python3.12 -m venv venv
    - source venv/bin/activate
    - python -m pip install --upgrade pip
    - pip install --no-cache-dir poetry
    - poetry config virtualenvs.create false --local
  script:
    - echo "Installing package with dev dependencies..."
    - poetry install --with dev
    - echo "Create config for testing"
    - mkdir -p ~/.config/bashman
    - touch ~/.config/bashman/config.json
    - echo "Running tests with pytest..."
    - poetry run pytest
    - echo "âœ… All tests passed"
    - echo "Coverage file location:"
    - ls -la coverage.xml || echo "coverage.xml not found"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
      - coverage.xml
    expire_in: 1 week
  coverage: '/^TOTAL.+?(\d+\%)$/'

sonar_scan:
  stage: scan
  script:
    - echo "Checking for coverage artifacts..."
    - ls -la coverage.xml || echo "coverage.xml not found in sonar_scan job"
    - pushd ~
    - curl -o /tmp/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}.zip
    - unzip -n /tmp/sonar-scanner.zip
    - popd
    - ~/sonar-scanner-${SONAR_SCANNER_VERSION}/bin/sonar-scanner -Dsonar.token=$SONAR_TOKEN -Dsonar.python.coverage.reportPaths=coverage.xml
  dependencies:
    - run_tests

build:
  stage: build
  script:
    - python3 -m venv /tmp/venv
    - source /tmp/venv/bin/activate
    - pip install poetry
    - poetry install --with dev
    - poetry build
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl
  needs:
    - sonar_scan

publish:
  stage: publish
  script:
    - python3 -m venv /tmp/venv
    - source /tmp/venv/bin/activate
    - pip install poetry
    - poetry install --with dev
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        echo "ðŸš€ Publishing to Nexus (main branch)"
        twine upload --repository-url https://nexus.ellisbs.co.uk/repository/pypi-hosted/ --username admin --password $PYPI_PASSWORD dist/*
      else
        echo "ðŸ” Rehearsing publish (branch: $CI_COMMIT_REF_NAME)"
        twine check dist/*
        echo "âœ… Package would be valid for publishing"
        echo "ðŸ“¦ Files that would be uploaded:"
        ls -la dist/
        echo "ðŸŽ­ Rehearsal complete - no actual upload performed"
      fi
  dependencies:
    - build

build_docker:
  image: docker.ellisbs.co.uk:5190/docker:24
  stage: build_docker
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_HOST: "unix:///root/run/docker-host.sock"
  script:
    - echo "192.168.0.2 docker.ellisbs.co.uk" >> /etc/hosts
    - echo "$DOCKER_PASSWORD" | docker login docker.ellisbs.co.uk:7070 -u "$DOCKER_USERNAME" --password-stdin
    - docker build -t $IMAGE_NAME .
    - docker push $IMAGE_NAME

deploy_bashman:
  image: docker.ellisbs.co.uk:5190/docker:24
  stage: deploy
  rules:
    - if: '$DEPLOY == "1"'
    - when: never   # default: never run unless the rule above matches
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_HOST: "unix:///root/run/docker-host.sock"
  script:
    - echo "Deploying Bashman app container..."
    - docker stop bashman-app || true
    - docker rm bashman-app || true
    - docker volume create bashman-data || true
    - docker run -d --name bashman-app -p 8000:8000 --restart unless-stopped -e BASHMAN_DB_PATH=/data/bashman.db -v /opt/bashman/:/data $IMAGE_NAME
    - echo "Waiting for app to become available..."
    - sleep 5
    - wget -q http://192.168.0.2:8000/health || (echo "Deployment failed"; exit 1)
    - apk add py-pip
    - python3 -m venv /tmp/venv
    - . /tmp/venv/bin/activate
    - pip install -e ".[dev]"
    - mkdir -p $HOME/.ssh
    - echo "$BASHMAN_SSH_KEY" > $HOME/.ssh/id_bashman
    - chmod -R 600 $HOME/.ssh
    - chmod 700 $HOME/.ssh
    - mkdir install-dir
    - python src/bashman/cli.py init --nickname developer --key-file $HOME/.ssh/id_bashman --install-dir ./install-dir
    - python src/bashman/cli.py list
    - python src/bashman/cli.py publish ./bin/rand_pass_key || echo "Already published, continuing"
    - python src/bashman/cli.py list
    - find ./install-dir
    - python src/bashman/cli.py install rand_pass_key
    - find ./install-dir
