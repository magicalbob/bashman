default:
  tags:
    - linux
  image: docker.ellisbs.co.uk:5190/ubuntu:24.04

stages:
  - test
  - scan
  - build
  - publish

variables:
  SONAR_SCANNER_VERSION: 5.0.1.3006

cache:
  paths:
    - .cache/pip/
    - venv/

run_tests:
  image: docker.ellisbs.co.uk:5190/python:3.12
  stage: test
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - python -m pip install --upgrade pip
  script:
    - echo "Installing package with dev dependencies..."
    - pip install -e .[dev]
    - echo "Running tests with pytest..."
    - python3 -m pytest
    - echo "‚úÖ All tests passed"
    - echo "Coverage file location:"
    - ls -la coverage.xml || echo "coverage.xml not found"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
      - coverage.xml
    expire_in: 1 week
  coverage: '/^TOTAL.+?(\d+\%)$/'

sonar_scan:
  stage: scan
  script:
    - echo "Checking for coverage artifacts..."
    - ls -la coverage.xml || echo "coverage.xml not found in sonar_scan job"
    - pushd ~
    - curl -o /tmp/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}.zip
    - unzip -n /tmp/sonar-scanner.zip
    - popd
    - ~/sonar-scanner-${SONAR_SCANNER_VERSION}/bin/sonar-scanner -Dsonar.token=$SONAR_TOKEN -Dsonar.python.coverage.reportPaths=coverage.xml
  dependencies:
    - run_tests

build:
  stage: build
  script:
    - python3 -m venv /tmp/venv
    - source /tmp/venv/bin/activate
    - pip install -e ".[dev]"
    - python3 -m build
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl
  needs:
    - sonar_scan

publish:
  stage: publish
  script:
    - python3 -m venv /tmp/venv
    - source /tmp/venv/bin/activate
    - pip install -e ".[dev]"
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        echo "üöÄ Publishing to Nexus (main branch)"
        twine upload --repository-url https://nexus.ellisbs.co.uk/repository/pypi-hosted/ --username admin --password $PYPI_PASSWORD dist/*
      else
        echo "üîç Rehearsing publish (branch: $CI_COMMIT_REF_NAME)"
        twine check dist/*
        echo "‚úÖ Package would be valid for publishing"
        echo "üì¶ Files that would be uploaded:"
        ls -la dist/
        echo "üé≠ Rehearsal complete - no actual upload performed"
      fi
  dependencies:
    - build
