stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  POETRY_CACHE_DIR: $CI_PROJECT_DIR/.poetry-cache
  POETRY_VENV_IN_PROJECT: "true"

# Cache Poetry dependencies between jobs
cache:
  paths:
    - .poetry-cache/
    - .venv/

# Test stage
test:
  stage: test
  image: python:3.12-slim
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends build-essential
    - pip install poetry
    - poetry config virtualenvs.in-project true
    - poetry install --with dev
  script:
    - poetry run pytest tests/ --cov=src/bashman --cov-report=xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week

# Build stage
build:
  stage: build
  image: python:3.12-slim
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends build-essential
    - pip install poetry
    - poetry config virtualenvs.in-project true
    - poetry install --with dev
  script:
    - poetry build
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

# Docker build stage
docker-build:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - develop

# Deploy to test environment
deploy-test:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker stop bashman-test || true
    - docker rm bashman-test || true
    - docker run -d --name bashman-test -p 8000:8000 $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - echo "Test deployment available at http://your-test-server:8000"
  environment:
    name: test
    url: http://your-test-server:8000
  only:
    - main
    - develop
  when: manual
